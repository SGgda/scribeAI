<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Medical Scribe</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .status-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        fieldset { border: 1px solid #e5e7eb; border-radius: 0.75rem; }
        legend { font-weight: 600; padding: 0 0.5rem; }
        .input-text {
            display: block; width: 100%; border-radius: 0.5rem; border: 1px solid #d1d5db; padding: 0.5rem 0.75rem;
            font-size: 0.875rem; line-height: 1.25rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .input-text:focus { border-color: #3b82f6; box-shadow: 0 0 0 2px #bfdbfe; outline: none; }
        .radio-label { display: flex; align-items: center; cursor: pointer; }
        .radio-input { height: 1rem; width: 1rem; border-color: #d1d5db; }
        .radio-input:checked { background-color: #3b82f6; }
    </style>
</head>
<body class="bg-gray-100 text-gray-900">

    <div class="container mx-auto p-4 md:p-8 max-w-5xl">
        <!-- Header and Controls remain the same -->
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold">Medical Scribe AI</h1>
            <p class="text-gray-600 mt-2">Record the patient consultation. The AI will fill the text fields automatically.</p>
        </header>

        <main id="medical-form-container" class="bg-white rounded-2xl shadow-xl p-6 md:p-8">
            <div id="status-container" class="text-center mb-6 p-4 rounded-lg bg-gray-50 border">
                <p class="text-lg font-semibold text-gray-700">Status</p>
                <p id="status-message" class="text-xl font-bold text-blue-600 min-h-[28px]">Press 'Start Recording' to begin.</p>
                <div id="loader" class="hidden animate-spin rounded-full h-5 w-5 border-b-2 border-blue-600 mx-auto mt-2"></div>
            </div>

            <div class="flex justify-center mb-8">
                <button id="record-button" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-all duration-300 ease-in-out transform hover:scale-105 flex items-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg>
                    <span id="button-text">Start Recording</span>
                </button>
                 <button id="reset-button" class="ml-4 bg-gray-500 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:bg-gray-600 focus:outline-none focus:ring-4 focus:ring-gray-300 transition-all">Reset Form</button>
            </div>
            
            <!-- NEW STATIC MEDICAL FORM -->
            <form id="medical-form" class="space-y-6">
                <!-- Section 1: Event Details -->
                <fieldset class="p-4 space-y-4">
                    <legend>Event Details</legend>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label for="organised_by" class="block text-sm font-medium text-gray-700">Organised By:</label><input type="text" id="organised_by" class="input-text mt-1"></div>
                        <div><label for="department" class="block text-sm font-medium text-gray-700">Department:</label><input type="text" id="department" class="input-text mt-1"></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                         <div><label for="event_date" class="block text-sm font-medium text-gray-700">Date:</label><input type="text" id="event_date" class="input-text mt-1"></div>
                         <div><label for="event_place" class="block text-sm font-medium text-gray-700">Place:</label><input type="text" id="event_place" class="input-text mt-1"></div>
                         <div><label for="event_district" class="block text-sm font-medium text-gray-700">District:</label><input type="text" id="event_district" class="input-text mt-1"></div>
                    </div>
                </fieldset>

                <!-- Section 2: Patient Demographics -->
                <fieldset class="p-4 space-y-4">
                    <legend>Patient Demographics</legend>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="md:col-span-2"><label for="patient_name" class="block text-sm font-medium text-gray-700">Name:</label><input type="text" id="patient_name" class="input-text mt-1"></div>
                        <div><label for="patient_age" class="block text-sm font-medium text-gray-700">Age:</label><input type="text" id="patient_age" class="input-text mt-1"></div>
                    </div>
                     <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div><label for="patient_contact" class="block text-sm font-medium text-gray-700">Contact:</label><input type="text" id="patient_contact" class="input-text mt-1"></div>
                        <div><label for="patient_education" class="block text-sm font-medium text-gray-700">Education:</label><input type="text" id="patient_education" class="input-text mt-1"></div>
                        <div>
                             <label class="block text-sm font-medium text-gray-700">Gender:</label>
                             <div class="flex space-x-4 mt-2">
                                <label class="radio-label"><input type="radio" name="gender" value="male" class="radio-input mr-2">Male</label>
                                <label class="radio-label"><input type="radio" name="gender" value="female" class="radio-input mr-2">Female</label>
                                <label class="radio-label"><input type="radio" name="gender" value="other" class="radio-input mr-2">Other</label>
                             </div>
                        </div>
                    </div>
                    <div><label for="family_monthly_income" class="block text-sm font-medium text-gray-700">Monthly Income of Family:</label><input type="text" id="family_monthly_income" class="input-text mt-1"></div>
                </fieldset>
                
                <!-- Section 3: Medical History -->
                 <fieldset class="p-4 space-y-4">
                    <legend>History & Complaint</legend>
                    <div><label for="chief_complaint" class="block text-sm font-medium text-gray-700">Chief Complaint:</label><textarea id="chief_complaint" rows="3" class="input-text mt-1"></textarea></div>
                    <div class="space-y-2">
                        <p class="text-sm font-medium text-gray-700">Past Medical History:</p>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-x-4 gap-y-2">
                            <!-- Helper function can create these -->
                            <div class="flex justify-between items-center"><span>Diabetes</span><div class="flex space-x-2"><label class="radio-label"><input type="radio" name="diabetes" value="yes">Y</label><label class="radio-label"><input type="radio" name="diabetes" value="no">N</label></div></div>
                            <div class="flex justify-between items-center"><span>Hypertension</span><div class="flex space-x-2"><label class="radio-label"><input type="radio" name="hypertension" value="yes">Y</label><label class="radio-label"><input type="radio" name="hypertension" value="no">N</label></div></div>
                            <div class="flex justify-between items-center"><span>Thyroid disorders</span><div class="flex space-x-2"><label class="radio-label"><input type="radio" name="thyroid" value="yes">Y</label><label class="radio-label"><input type="radio" name="thyroid" value="no">N</label></div></div>
                            <div class="flex justify-between items-center"><span>Cardiovascular</span><div class="flex space-x-2"><label class="radio-label"><input type="radio" name="cardio" value="yes">Y</label><label class="radio-label"><input type="radio" name="cardio" value="no">N</label></div></div>
                            <div class="flex justify-between items-center"><span>Respiratory</span><div class="flex space-x-2"><label class="radio-label"><input type="radio" name="respiratory" value="yes">Y</label><label class="radio-label"><input type="radio" name="respiratory" value="no">N</label></div></div>
                            <div class="flex justify-between items-center"><span>Bleeding disorders</span><div class="flex space-x-2"><label class="radio-label"><input type="radio" name="bleeding" value="yes">Y</label><label class="radio-label"><input type="radio" name="bleeding" value="no">N</label></div></div>
                        </div>
                    </div>
                    <div><label for="past_medical_history_others" class="block text-sm font-medium text-gray-700">Others (Medical):</label><input type="text" id="past_medical_history_others" class="input-text mt-1"></div>
                    <div><label for="past_dental_visit_details" class="block text-sm font-medium text-gray-700">Past Dental Visit:</label><input type="text" id="past_dental_visit_details" class="input-text mt-1"></div>
                </fieldset>

                <!-- Section 4: Habits -->
                <fieldset class="p-4 space-y-2">
                     <legend>Personal Habits</legend>
                     <div class="grid grid-cols-2 md:grid-cols-3 gap-x-4 gap-y-2">
                        <div class="flex justify-between items-center"><span>Smoking</span><div class="flex space-x-2"><label class="radio-label"><input type="radio" name="smoking" value="yes">Y</label><label class="radio-label"><input type="radio" name="smoking" value="no">N</label></div></div>
                        <div class="flex justify-between items-center"><span>Alcohol</span><div class="flex space-x-2"><label class="radio-label"><input type="radio" name="alcohol" value="yes">Y</label><label class="radio-label"><input type="radio" name="alcohol" value="no">N</label></div></div>
                        <div class="flex justify-between items-center"><span>Smokeless Tobacco</span><div class="flex space-x-2"><label class="radio-label"><input type="radio" name="tobacco" value="yes">Y</label><label class="radio-label"><input type="radio" name="tobacco" value="no">N</label></div></div>
                     </div>
                     <div><label for="personal_habits_others" class="block text-sm font-medium text-gray-700 mt-2">Others (Habits):</label><input type="text" id="personal_habits_others" class="input-text mt-1"></div>
                </fieldset>

                <!-- Section 5: Clinical Examination -->
                <fieldset class="p-4 space-y-4">
                    <legend>Clinical Examination</legend>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                        <div><label for="clinical_decayed" class="block text-sm font-medium text-gray-700">Decayed:</label><input type="text" id="clinical_decayed" class="input-text mt-1"></div>
                        <div><label for="clinical_missing" class="block text-sm font-medium text-gray-700">Missing:</label><input type="text" id="clinical_missing" class="input-text mt-1"></div>
                        <div><label for="clinical_filled" class="block text-sm font-medium text-gray-700">Filled:</label><input type="text" id="clinical_filled" class="input-text mt-1"></div>
                        <div><label for="clinical_pain" class="block text-sm font-medium text-gray-700">Pain:</label><input type="text" id="clinical_pain" class="input-text mt-1"></div>
                        <div><label for="clinical_fractured_teeth" class="block text-sm font-medium text-gray-700">Fractured Teeth:</label><input type="text" id="clinical_fractured_teeth" class="input-text mt-1"></div>
                        <div><label for="clinical_mobility" class="block text-sm font-medium text-gray-700">Mobility:</label><input type="text" id="clinical_mobility" class="input-text mt-1"></div>
                    </div>
                     <div><label for="clinical_examination_others" class="block text-sm font-medium text-gray-700">Others (Examination):</label><input type="text" id="clinical_examination_others" class="input-text mt-1"></div>
                </fieldset>

                 <!-- Section 6: Gingiva & Oral Health -->
                <fieldset class="p-4 space-y-4">
                    <legend>Gingiva & Oral Health</legend>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                         <div class="flex justify-between items-center"><span>Calculus</span><div class="flex space-x-2"><label class="radio-label"><input type="radio" name="calculus" value="yes">Y</label><label class="radio-label"><input type="radio" name="calculus" value="no">N</label></div></div>
                         <div class="flex justify-between items-center"><span>Stains</span><div class="flex space-x-2"><label class="radio-label"><input type="radio" name="stains" value="yes">Y</label><label class="radio-label"><input type="radio" name="stains" value="no">N</label></div></div>
                         <div class="flex justify-between items-center"><span>Dental Fluorosis</span><div class="flex space-x-2"><label class="radio-label"><input type="radio" name="fluorosis" value="yes">Y</label><label class="radio-label"><input type="radio" name="fluorosis" value="no">N</label></div></div>
                         <div class="flex justify-between items-center"><span>Malocclusion</span><div class="flex space-x-2"><label class="radio-label"><input type="radio" name="malocclusion" value="yes">Y</label><label class="radio-label"><input type="radio" name="malocclusion" value="no">N</label></div></div>
                         <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Chronic Gingivitis:</label>
                            <div class="flex space-x-2"><label class="radio-label"><input type="radio" name="gingivitis" value="localized">L</label><label class="radio-label"><input type="radio" name="gingivitis" value="generalized">G</label><label class="radio-label"><input type="radio" name="gingivitis" value="none">N</label></div>
                         </div>
                         <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Chronic Periodontitis:</label>
                            <div class="flex space-x-2"><label class="radio-label"><input type="radio" name="periodontitis" value="localized">L</label><label class="radio-label"><input type="radio" name="periodontitis" value="generalized">G</label><label class="radio-label"><input type="radio" name="periodontitis" value="none">N</label></div>
                         </div>
                    </div>
                     <div><label for="oral_mucosal_lesion" class="block text-sm font-medium text-gray-700">Oral Mucosal Lesion:</label><input type="text" id="oral_mucosal_lesion" class="input-text mt-1"></div>
                     <div><label for="teeth_cleaning_method" class="block text-sm font-medium text-gray-700">Method of Cleaning Teeth:</label><input type="text" id="teeth_cleaning_method" class="input-text mt-1"></div>
                </fieldset>

                <!-- Section 7: Plan -->
                <fieldset class="p-4 space-y-4">
                    <legend>Conclusion</legend>
                    <div><label for="doctors_name" class="block text-sm font-medium text-gray-700">Doctor's Name:</label><input type="text" id="doctors_name" class="input-text mt-1"></div>
                    <div><label for="treatment_plan" class="block text-sm font-medium text-gray-700">Treatment Plan:</label><textarea id="treatment_plan" rows="4" class="input-text mt-1"></textarea></div>
                </fieldset>
            </form>
        </main>
    </div>

    <script>
        // --- Element Selection ---
        const recordButton = document.getElementById('record-button');
        const resetButton = document.getElementById('reset-button');
        const buttonText = document.getElementById('button-text');
        const statusMessage = document.getElementById('status-message');
        const loader = document.getElementById('loader');
        const medicalForm = document.getElementById('medical-form');

        // --- State Management ---
        let isRecording = false;
        let mediaRecorder;
        let audioChunks = [];

        // --- Core Functions ---
        const startRecording = () => {
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
                    mediaRecorder.start();
                    isRecording = true;

                    // Update UI for recording state
                    buttonText.textContent = 'Stop Recording';
                    recordButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    recordButton.classList.add('bg-red-600', 'hover:bg-red-700', 'status-pulse');
                    resetButton.disabled = true;
                    resetButton.classList.add('opacity-50');
                    updateStatus('Recording consultation...', 'red');

                    mediaRecorder.addEventListener("dataavailable", event => audioChunks.push(event.data));
                    mediaRecorder.addEventListener("stop", processAudio);
                })
                .catch(err => {
                    console.error("Mic access error:", err);
                    updateStatus("Error: Could not access microphone.", "red");
                });
        };

        const stopRecording = () => {
            if (mediaRecorder) {
                mediaRecorder.stop();
                isRecording = false;
                // Update UI for processing state
                buttonText.textContent = 'Processing...';
                recordButton.disabled = true;
                recordButton.classList.remove('bg-red-600', 'hover:bg-red-700', 'status-pulse');
                recordButton.classList.add('bg-gray-500', 'opacity-50');
                loader.classList.remove('hidden');
                updateStatus('Transcribing and analyzing... Please wait.', 'blue');
            }
        };

        const processAudio = async () => {
            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
            const formData = new FormData();
            formData.append('audio_data', audioBlob, 'consultation.webm');

            try {
                const response = await fetch('/process_audio', { method: 'POST', body: formData });
                if (!response.ok) {
                    const errorResult = await response.json();
                    throw new Error(errorResult.error || `Server error: ${response.statusText}`);
                }
                const result = await response.json();
                handleApiResponse(result);
            } catch (error) {
                console.error('Error processing audio:', error);
                updateStatus(`Error: ${error.message}`, 'red');
            } finally {
                // Reset UI to idle state
                audioChunks = [];
                recordButton.disabled = false;
                buttonText.textContent = 'Start Recording';
                recordButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
                recordButton.classList.remove('bg-gray-500', 'opacity-50');
                resetButton.disabled = false;
                resetButton.classList.remove('opacity-50');
                loader.classList.add('hidden');
            }
        };

        const handleApiResponse = (result) => {
            if (result.error) {
                updateStatus(`Error: ${result.error}`, 'red');
                return;
            }
            const data = result.extracted_data;
            let filledCount = 0;
            // Loop through the data from the AI
            for (const key in data) {
                // Find the corresponding input/textarea element by its ID
                const inputElement = document.getElementById(key);
                if (inputElement) { // Check if the element exists on the page
                    const value = data[key];
                    if (value) { // Only fill if the AI found a value
                        inputElement.value = value;
                        filledCount++;
                    }
                }
            }
            updateStatus(`Analysis complete. ${filledCount} fields were filled. Please review and complete the form.`, 'green');
        };

        // --- UI Update & Event Listeners ---
        const updateStatus = (message, color) => {
            statusMessage.textContent = message;
            statusMessage.className = `text-xl font-bold min-h-[28px]`;
            const colorClasses = { blue: 'text-blue-600', green: 'text-green-600', red: 'text-red-600' };
            if (colorClasses[color]) statusMessage.classList.add(colorClasses[color]);
        };

        const resetForm = () => {
            medicalForm.reset(); // This is the simplest way to clear a form
            updateStatus("Press 'Start Recording' to begin.", 'blue');
            recordButton.disabled = false;
        };

        recordButton.addEventListener('click', () => {
            if (isRecording) stopRecording();
            else startRecording();
        });
        resetButton.addEventListener('click', resetForm);
    </script>
</body>
</html>

